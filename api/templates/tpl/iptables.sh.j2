#!/usr/bin/env bash

{# FILTERS #}
iptables -N vagabond-input
iptables -N vagabond-forward
iptables -N vagabond-output
iptables -F vagabond-input
iptables -F vagabond-forward
iptables -F vagabond-output
iptables -C INPUT -j vagabond-input || iptables -A INPUT -j vagabond-input
iptables -C FORWARD -j vagabond-forward || iptables -A FORWARD -j vagabond-forward
iptables -C OUTPUT -j vagabond-output || iptables -A OUTPUT -j vagabond-output

{#- Allow loopback as long as it's on the correct interface #}
iptables -A vagabond-input -i lo -j ACCEPT
iptables -A vagabond-input -d 127.0.0.0/8 -j REJECT

{#- Allow established connections to continue #}
iptables -A vagabond-input -m state --state ESTABLISHED,RELATED -j ACCEPT

{#- Allow outbound traffic #}
iptables -A vagabond-output -j ACCEPT

{#- Allow ping and forwarding for wlan #}
{%- if network.wlan_enabled %}
iptables -A vagabond-input -p icmp -i {{ network.wlan_interface }} -j ACCEPT
iptables -A vagabond-forward -i {{ network.wlan_interface }} -j ACCEPT
iptables -A vagabond-forward -o {{ network.wlan_interface }} -j ACCEPT
{%- endif %}

{#- Allow ping and forwarding for lan #}
{%- if network.lan_enabled %}
iptables -A vagabond-input -p icmp -i {{ network.lan_interface }} -j ACCEPT
iptables -A vagabond-forward -i {{ network.lan_interface }} -j ACCEPT
iptables -A vagabond-forward -o {{ network.lan_interface }} -j ACCEPT
{%- endif %}

{#- Drop all other traffic #}
iptables -A vagabond-input -j DROP
iptables -A vagabond-forward -j DROP

{# NAT #}
iptables -t nat -N vagabond-prerouting
iptables -t nat -N vagabond-input
iptables -t nat -N vagabond-output
iptables -t nat -N vagabond-postrouting
iptables -t nat -F vagabond-prerouting
iptables -t nat -F vagabond-input
iptables -t nat -F vagabond-output
iptables -t nat -F vagabond-postrouting
iptables -t nat -C PREROUTING -j vagabond-prerouting || iptables -t nat -A PREROUTING -j vagabond-prerouting
iptables -t nat -C INPUT -j vagabond-input || iptables -t nat -A INPUT -j vagabond-input
iptables -t nat -C OUTPUT -j vagabond-output || iptables -t nat -A OUTPUT -j vagabond-output
iptables -t nat -C POSTROUTING -j vagabond-postrouting || iptables -t nat -A POSTROUTING -j vagabond-postrouting
{# Route external interfaces #}
{%- for iface in network.external_interfaces %}
iptables -t nat -A vagabond-postrouting -o {{ iface }} -j MASQUERADE
{%- endfor %}
